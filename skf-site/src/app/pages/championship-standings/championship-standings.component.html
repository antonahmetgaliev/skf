<section class="standings-page">
  <header class="page-intro">
    <p class="eyebrow">SKF Racing Hub</p>
    <h1>Championship Standings</h1>
    <p class="subtitle">
      Retrieve your championships from The SimGrid API and view current standings.
    </p>
  </header>

  <div class="layout">
    <aside class="card side-panel">
      <div class="panel-header">
        <h2>Championships</h2>
        <button class="btn ghost small" type="button" (click)="loadChampionships()">
          Reload
        </button>
      </div>

      @if (loadingChampionships()) {
        <p class="empty">Loading championships...</p>
      } @else if (championships().length === 0) {
        <p class="empty">No championships returned from API.</p>
      } @else {
        <div class="championship-list">
          @for (item of championships(); track item.id) {
            <button
              class="championship-button"
              type="button"
              [class.active]="selectedChampionshipId() === item.id"
              (click)="selectChampionship(item.id)"
            >
              <span class="championship-name">{{ item.name }}</span>
              <span class="championship-id">#{{ item.id }}</span>
            </button>
          }
        </div>
      }
    </aside>

    <section class="card details-panel">
      @if (loadingStandings()) {
        <p class="empty">Loading standings...</p>
      } @else if (errorMessage()) {
        <p class="error">{{ errorMessage() }}</p>
      } @else if (selectedChampionship(); as championship) {
        <div class="details-header">
          <div>
            <h2>{{ championship.name }}</h2>
            <p class="meta">
              {{ championship.hostName }} - {{ championship.gameName }} -
              {{ championship.spotsTaken ?? 0 }}/{{ championship.capacity ?? 0 }} entries
            </p>
            <p class="meta">
              Start date: {{ formatDate(championship.startDate) }}
              @if (championship.endDate) {
                - End date: {{ formatDate(championship.endDate) }}
              }
            </p>
            @if (lastUpdated(); as updated) {
              <p class="meta">Last refresh: {{ updated.toLocaleString() }}</p>
            }
          </div>
          <div class="details-actions">
            <button class="btn ghost small" type="button" (click)="openGiveawayModal()">
              Giveaway
            </button>
            <button class="btn ghost small" type="button" (click)="openStandingsExportPreview()">
              Export 16:9
            </button>
            <button class="btn ghost small" type="button" [disabled]="refreshingCache()" (click)="refreshCache()">
              {{ refreshingCache() ? 'Refreshing...' : 'Refresh Cache' }}
            </button>
            <button class="btn accent small" type="button" (click)="refreshSelectedChampionship()">
              Refresh
            </button>
          </div>
        </div>

        @if (infoMessage()) {
          <p class="notice">{{ infoMessage() }}</p>
        }

        <h3 class="section-title">Overall standings</h3>
        <div class="table-wrap">
          <table class="standings-table">
            <thead>
              <tr>
                <th>Pos</th>
                <th>Driver</th>
                <th>Country</th>
                <th>Car</th>
                <th>Score</th>
                @for (race of races(); track race.id; let raceIndex = $index) {
                  <th [attr.title]="getRaceTitle(race, raceIndex)">{{ getRaceLabel(raceIndex) }}</th>
                }
              </tr>
            </thead>
            <tbody>
              @if (standings().length === 0) {
                <tr>
                  <td class="empty-row" [attr.colspan]="getOverallColspan()">
                    No standings available for this championship yet.
                  </td>
                </tr>
              } @else {
                @for (entry of standings(); track entry.id; let i = $index) {
                  <tr>
                    <td>{{ getPosition(entry, i) }}</td>
                    <td class="driver-cell">
                      {{ entry.displayName }}
                      @if (entry.dsq) {
                        <span class="dsq-badge">DSQ</span>
                      }
                    </td>
                    <td>{{ entry.countryCode || '-' }}</td>
                    <td>{{ entry.car || '-' }}</td>
                    <td>{{ formatNumber(entry.score) }}</td>
                    @for (race of races(); track race.id; let raceIndex = $index) {
                      <td class="race-position">{{ formatRacePosition(entry, race, raceIndex) }}</td>
                    }
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>
      } @else {
        <p class="empty">Select a championship to view standings.</p>
      }
    </section>
  </div>
</section>

  @if (giveawayOpen()) {
    <div class="export-backdrop" (click)="closeGiveawayModal()">
      <section class="giveaway-modal" (click)="$event.stopPropagation()">
        <header class="export-modal-header">
          <h3>Giveaway â€” Eligible Drivers</h3>
          <div class="export-modal-actions">
            <label class="giveaway-input-label">
              Min races
              <input
                class="giveaway-input"
                type="number"
                min="1"
                [value]="giveawayMinRaces()"
                (input)="onGiveawayMinRacesChange($event)"
              />
            </label>
            <button class="btn ghost small" type="button" (click)="closeGiveawayModal()">
              Close
            </button>
          </div>
        </header>

        <div class="giveaway-body">
          @if (giveawayWinner(); as winner) {
            <div class="giveaway-winner">
              <span class="giveaway-winner-label">Winner</span>
              <span class="giveaway-winner-name">{{ winner }}</span>
            </div>
          }

          <div class="giveaway-random-row">
            <button
              class="btn accent small"
              type="button"
              [disabled]="giveawayDrivers().length === 0"
              (click)="pickRandomDriver()"
            >
              Get Random
            </button>
          </div>

          @if (giveawayDrivers().length === 0) {
            <p class="empty">No drivers match the minimum race requirement.</p>
          } @else {
            <p class="giveaway-count">{{ giveawayDrivers().length }} driver(s) eligible</p>
            <div class="giveaway-list">
              @for (driver of giveawayDrivers(); track driver.id; let i = $index) {
                <div class="giveaway-driver">
                  <span class="giveaway-rank">{{ i + 1 }}</span>
                  <span class="giveaway-name">{{ driver.displayName }}</span>
                  <span class="giveaway-races">{{ driver.racesCount }} race(s)</span>
                </div>
              }
            </div>
          }
        </div>
      </section>
    </div>
  }

  @if (exportPreviewOpen()) {
    <div class="export-backdrop" (click)="closeStandingsExportPreview()">
      <section class="export-modal" (click)="$event.stopPropagation()">
        <header class="export-modal-header">
          <h3>Standings Poster Preview (16:9)</h3>
          <div class="export-modal-actions">
            <button class="btn ghost small" type="button" (click)="closeStandingsExportPreview()">
              Close
            </button>
            <button class="btn accent small" type="button" [disabled]="exportRendering()" (click)="downloadStandingsExportJpg()">
              Download JPG
            </button>
          </div>
        </header>

        <div class="export-preview-frame">
          <canvas #standingsExportCanvas width="1920" height="1080"></canvas>
          @if (exportRendering()) {
            <p class="export-rendering">Rendering preview...</p>
          }
        </div>
      </section>
    </div>
  }

